{% extends "base.html" %}

{% block title %}Dashboard - Credit Management{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <div>
            <h1>Credit Management Dashboard</h1>
            <p style="color: #666; margin-top: 5px;">User: {{ user_code }}{% if is_admin %} (Admin){% endif %}</p>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            {% if stores %}
            <form method="POST" action="{{ url_for('select_store') }}" style="display: flex; gap: 10px;">
                <select name="store_id" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    {% for store in stores %}
                    <option value="{{ store['store_id'] }}" {% if store['store_id'] == selected_store %}selected{% endif %}>
                        {{ store['store_id'] }} - {{ store['name'] }}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-secondary">Change Store</button>
            </form>
            {% endif %}
        </div>
    </div>
    
    {% if not selected_store %}
    <div class="card">
        <p style="text-align: center; color: #666;">
            {% if stores %}
            Please select a store above to continue.
            {% else %}
            No stores assigned. Please contact an administrator.
            {% endif %}
        </p>
    </div>
    {% else %}
    
    <div class="grid">
        <!-- Create Credit Card -->
        <div class="card">
            <h3 style="margin-bottom: 20px; color: #333;">Create New Credit</h3>
            <form method="POST" action="{{ url_for('create_credit') }}">
                <div class="form-group">
                    <label for="items">Items</label>
                    <input type="text" id="items" name="items" required>
                </div>
                
                <div class="form-group">
                    <label for="reason">Reason</label>
                    <textarea id="reason" name="reason" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="date_of_issue">Date of Issue</label>
                    <input type="date" id="date_of_issue" name="date_of_issue" 
                           value="{{ now().strftime('%Y-%m-%d') }}">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Generate Credit Code
                </button>
            </form>
        </div>
        
        <!-- Claim Credit Card -->
        <div class="card">
            <h3 style="margin-bottom: 20px; color: #333;">Claim Credit</h3>
            <form method="POST" action="{{ url_for('claim_credit') }}">
                <div class="form-group">
                    <label for="code">Credit Code (3 characters)</label>
                    <input type="text" id="code" name="code" maxlength="3" 
                           style="text-transform: uppercase;" required>
                </div>
                
                <div class="form-group">
                    <label for="customer_name">Customer Name</label>
                    <input type="text" id="customer_name" name="customer_name" required>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Claim Credit
                </button>
            </form>
        </div>
    </div>
    
    <!-- Credits List -->
    <div class="card">
        <h3 style="margin-bottom: 20px; color: #333;">Credits for Store {{ selected_store }}</h3>
        
        {% if credits %}
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Items</th>
                        <th>Reason</th>
                        <th>Date of Issue</th>
                        <th>Status</th>
                        <th>Claimed By</th>
                        <th>Claimed At</th>
                        <th>Created By</th>
                    </tr>
                </thead>
                <tbody>
                    {% for credit in credits %}
                    <tr>
                        <td><strong>{{ credit['code'] }}</strong></td>
                        <td>{{ credit['items'] }}</td>
                        <td>{{ credit['reason'] }}</td>
                        <td>{{ credit['date_of_issue'] }}</td>
                        <td>
                            <span class="badge badge-{{ credit['status'] }}">
                                {{ credit['status'].upper() }}
                            </span>
                        </td>
                        <td>{{ credit['claimed_by'] or '-' }}</td>
                        <td>{{ credit['claimed_at'][:10] if credit['claimed_at'] else '-' }}</td>
                        <td>{{ credit['created_by'] or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="text-align: center; color: #666; padding: 40px;">
            No credits found for this store. Create your first credit above!
        </p>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
