{% extends "base.html" %}

{% block title %}Dashboard - Credit Management{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <div>
            <h1>Credit Management Dashboard</h1>
            <p style="color: #666; margin-top: 5px;">User: {{ user_code }}{% if is_admin %} (Admin){% endif %}</p>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            {% if stores %}
            <form method="POST" action="{{ url_for('select_store') }}" style="display: flex; gap: 10px;">
                <select name="store_id" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    {% for store in stores %}
                    <option value="{{ store['store_id'] }}" {% if store['store_id'] == selected_store %}selected{% endif %}>
                        {{ store['store_id'] }} - {{ store['name'] }}
                    </option>
                    {% endfor %}
                </select>
                <button type="submit" class="btn btn-secondary">Change Store</button>
            </form>
            {% endif %}
        </div>
    </div>
    
    {% if not selected_store %}
    <div class="card">
        <p style="text-align: center; color: #666;">
            {% if stores %}
            Please select a store above to continue.
            {% else %}
            No stores assigned. Please contact an administrator.
            {% endif %}
        </p>
    </div>
    {% else %}
    
    <div class="grid">
        <!-- Create Credit Card -->
        <div class="card">
            <h3 style="margin-bottom: 20px; color: #333;">Create New Credit</h3>
            <form method="POST" action="{{ url_for('create_credit') }}">
                <div class="form-group">
                    <label for="items">Items</label>
                    <input type="text" id="items" name="items" required>
                </div>
                
                <div class="form-group">
                    <label for="reason">Reason</label>
                    <textarea id="reason" name="reason" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="date_of_issue">Date of Issue</label>
                    <input type="date" id="date_of_issue" name="date_of_issue">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    Generate Credit Code
                </button>
            </form>
        </div>
    </div>
    
    <!-- Credits List -->
    <div class="card">
        <h3 style="margin-bottom: 20px;">Credits for Store {{ selected_store }}</h3>
        
        {% if credits %}
        <!-- Search Bar -->
        <div class="search-container">
            <input type="text" id="credit-search" placeholder="Search by code or phone number...">
        </div>
        
        <!-- Credits Grid -->
        <div class="credits-grid" data-claim-url="{{ url_for('claim_credit') }}">
            {% for credit in credits %}
            <div class="credit-tile" data-status="{{ credit['status'] }}" data-code="{{ credit['code'] }}" data-claimed-by="{{ credit['claimed_by'] or '' }}">
                <div class="tile-header">
                    <span class="credit-code">{{ credit['code'] }}</span>
                    <span class="status-badge {{ credit['status'] }}">{{ credit['status'].upper() }}</span>
                </div>
                <div class="tile-body">
                    <p><strong>Items:</strong> {{ credit['items'] }}</p>
                    <p><strong>Reason:</strong> {{ credit['reason'] }}</p>
                    <p><strong>Date:</strong> {{ credit['date_of_issue'] }}</p>
                    {% if credit['status'] == 'claimed' %}
                    <p><strong>Claimed By:</strong> {{ credit['claimed_by'] }}</p>
                    <p><strong>Claimed At:</strong> {{ credit['claimed_at'][:19] if credit['claimed_at'] else '-' }}</p>
                    {% endif %}
                    <p><strong>Created By:</strong> {{ credit['created_by'] or '-' }}</p>
                </div>
                {% if credit['status'] == 'active' %}
                <div class="tile-footer">
                    <button class="btn-claim">Claim</button>
                </div>
                <!-- Inline claim form (hidden by default) -->
                <div class="claim-form" id="claim-form-{{ credit['code'] }}" style="display:none;">
                    <input type="text" placeholder="Customer name/phone" id="claim-input-{{ credit['code'] }}">
                    <div class="claim-form-buttons">
                        <button class="btn-submit">Submit</button>
                        <button class="btn-cancel">Cancel</button>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        
        <!-- No Results Message -->
        <div id="no-results" class="no-results" style="display:none;">
            No credits found matching your search.
        </div>
        {% else %}
        <p style="text-align: center; color: #666; padding: 40px;">
            No credits found for this store. Create your first credit above!
        </p>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
